<!DOCTYPE html>
<html>
<head>
	<!--
	  Project XMRemoteRobot - example of client-side processing for a robot vehicle
	  Copyright © 2017 John Calder as project leader
	  Licensed under the "Open Source" Apache License, Version 2.0.
	  See file LICENSE in the parent project root.
	  In brief, a generous license with some attribution rights reserved.
	  Questions? Contact John via the parent app contact+about page.
	-->

	<meta name="viewport" content="width=device-width">
	<!-- Code for "DroidScript" hybrid apps, comment-out for web-based
	 <script src='file:///android_asset/app.js'></script> -->

	<script src="https://www.gstatic.com/firebasejs/3.6.4/firebase.js"></script>
    <script src="signalr.min.js"></script>

	<script>
        var _timer
		var _allowLocation = true;
		var _oeCommanderId;
		var _robotMode = "None";
		var _videoMimeType = 'video/webm';
		var _speechResponse = "";

		var RobotMode = {
			None: "None",
			LiveStream: "LiveStream",
			MotionDetect: "MotionDetect",
			SpeechRecognition: "SpeechRecognition"
		}

		// 20171015 SA Variable to store the robot's current location information
        var _currentPosition;

        var _message;

        const connection
            = new signalR.HubConnectionBuilder().withUrl("/robothub").build();

		//Called after application is started.
		function onStart() {
			document.getElementById("gx1x3").style.backgroundColor = "firebrick";
			document.getElementById("gx2x3").style.backgroundColor = "firebrick";
			_oeCommanderId = document.getElementById("CommanderId");
            getLocation();
            //
            try {
                connection.start();
            } catch (err) {
                alert("Error on first connection: " + err.message);
            }
        }

        //receive from server
        connection.on("XSignal", function (messageReceived) {
            _message = messageReceived;
            receive();
        });

        function register() {
            var oMessage = new Object();
            oMessage.categoryid = 6;  //register a robot on the server
            oMessage.commanderid = parseInt(document.getElementById("CommanderId").value);
            oMessage.robotid = oMessage.commanderid + 100;
            oMessage.accesskey = "demo-access-key";
            _message = JSON.stringify(oMessage);
            //alert(message);
            connection.invoke("XSignal", _message);
        }

        //send to server
        function send() {
            var oMessage = new Object();
            oMessage.categoryid = 2;
            oMessage.commanderid = document.getElementById("CommanderId").value;
            oMessage.robotid = parseInt(oMessage.commanderid) + 100;
            oMessage.accesskey = "demo-access-key";

            var oXData = new Object();
            oXData.status = 300;
            var d = new Date();
            oXData.timestamp = d;
            if (_currentPosition) {
                oXData.latitude = _currentPosition.coords.latitude;
                oXData.longitude = _currentPosition.coords.longitude;
            } else {
                oXData.response = "Location - no information";
            }
            //oXData.speechResponse = _speechResponse;
            oMessage.xdata = oXData;

            _message = JSON.stringify(oMessage);
            //alert(_message);
            connection.invoke("XSignal", _message);
        }

        function receive() {
            //alert(_message);

            document.getElementById("XMessage").value = _message;

            var oMessage = JSON.parse(_message);
            ////20180803 JPC changed check for existence of vx1x1
            //ref: https://humanwhocodes.com/blog/2010/07/27/determining-if-an-object-property-exists/
            //  Change child object name from command to xdata
            if ("vx1x1" in oMessage.xdata) {
                setPatchLevel("gx1x1", oMessage.xdata.vx1x1);
                setPatchLevel("gx1x2", oMessage.xdata.vx1x2);
                setPatchLevel("gx2x1", oMessage.xdata.vx2x1);
                setPatchLevel("gx2x2", oMessage.xdata.vx2x2);
            }
            // send response with location info
            send();
        }

        // 20171015 SA Continuously watch the position of the device and call the showPosition function
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(showPosition);
            }
        }

        // 20171015 SA Store the robot's current location in currentPosition as soon as it is found
        function showPosition(position) {
            if (_allowLocation)
                _currentPosition = position;
            else
                _currentPosition = undefined;
        }

		//setPatchLevel("gx1x1", y);
		function setPatchLevel(patchId, value) {
			var patch = document.getElementById(patchId);
			//20170815 7:58 PM Pratik allow for non-linear electric motor behaviour
			// by applying an ellipse curve
			var y1 = [(255 * 255) - ((((value - 100) * (value - 100)) * (255 * 255)) / 10000)];
			var y = Math.round(Math.sqrt(y1));
            patch.style.backgroundColor = "rgb(" + y + "," + y + "," + y + ")";
		}
	</script>

	<style>
		/*20170806 JPC
			The font-size for selector * defines the em
			and so sets all significant scaling
			Fine-tune the font-size to get the light patches
			to line up with the LDRs*/
		/*TODO - alter this programmatically from a UI slider control*/
		* {
			font-family: Courier New, Courier, monospace;
			font-size: 0.4cm;
		}

		body {
			background-color: black;
		}

		/*3 x 2 simplest light patch design */
		table {
			position: absolute;
			top: 15em;
			width: 19.5em;
			height: 13em;
			/*gives thin blue line effect between cells, good for adjusting alignment with the LDRs*/
			background-color: blue;
		}

		td {
			box-sizing: border-box;
			border: 2em solid black;
			background-color: white;
			font-size: 0.4em;
		}

		textarea {
			margin-top: 425px;
		}

		#robot-eyes {
			position: absolute;
			margin-top: 25px;
			width: 295px;
		}

		video {
			height: 0;
			width: 0;
		}

		#motion {
			visibility: hidden;
		}
	</style>
</head>

<!-- variation from "DroidScript" where onload=app.onStart() -->
<body onload="onStart();">
	<img id="robot-eyes" src="../images/cute-eyes.gif" />
	<textarea id="XMessage" cols="30" rows="7"></textarea>
	<br /><br />
	<input type="text" style="width:4em" id="CommanderId" value="0" />
	<span style="color:white"> &lt;-- CommanderId
        <button onclick="register()">Register</button>
    </span>

	<table>
		<tr>
			<td id="gx1x1">gx1x1</td>
			<td id="gx1x2">gx1x2</td>
			<td id="gx1x3">gx1x3</td>
		</tr>
		<tr>
			<td id="gx2x1">gx2x1</td>
			<td id="gx2x2">gx2x2</td>
			<td id="gx2x3">gx2x3</td>
		</tr>
	</table>

	<script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>

</body>
</html>
